<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <style>
    </style>
</head>

<body class="clearfix">

    <button id="clickButton">click me</button>

    <script type="text/javascript">

        function Promise(excutor) {
            this.PromiseState = 'pending'
            this.PromiseResult = null
            this.callback = []
            self = this
            function resolve(data) {
                if (self.PromiseState !== 'pending') return
                self.PromiseState = 'fulfilled'
                self.PromiseResult = data
                self.callback.forEach(item => {
                    item.onResolved(data)
                });
                // if (self.callback.onResolved) {
                //     self.callback.onResolved(data)
                // }
            }
            function reject(data) {
                if (self.PromiseState !== 'pending') return
                self.PromiseState = 'rejected'
                self.PromiseResult = data
                self.callback.forEach(item => {
                    item.onResolved(data)
                });
                // if (self.callback.onRejected) {
                //     self.callback.onRejected(data)
                // }
            }
            try {
                excutor(resolve, reject)
            } catch (error) {
                reject(error)
            }

        }

        Promise.prototype.then = function (onResolved, onRejected) {
            self = this
            if(onRejected!=='function'){
                onRejected= reason=>{
                    throw reason
                }
            }
            return new Promise((resolve, reject) => {
                if (this.PromiseState === 'fulfilled') {
                    let result = onResolved(this.PromiseResult)
                    if (result instanceof Promise) {
                        result.then((result) => {
                            resolve(result)
                        }, (err) => {
                            reject(err)
                        })
                    } else {
                        resolve(result)
                    }
                }
                if (this.PromiseState === 'rejected') {
                    console.error('rejected')
                    let result = onRejected(this.PromiseResult)
                    if (result instanceof Promise) {
                        result.then((result) => {
                            resolve(result)
                        }, (err) => {
                            reject(err)
                        })
                    } else {
                        resolve(result)
                    }
                }
                if (this.PromiseState === 'pending') {
                    this.callback.push(
                        {
                            onResolved: function () {
                                console.error('success')
                                let result = onResolved(self.PromiseResult)
                                if (result instanceof Promise) {
                                    result.then((result) => {
                                        resolve(result)
                                    }, (err) => {
                                        reject(err)
                                    })
                                } else {
                                    resolve(result)
                                }
                            },
                            onRejected: function () {
                                console.error('error')
                                let result = onRejected(self.PromiseResult)
                                if (result instanceof Promise) {
                                    result.then((result) => {
                                        resolve(result)
                                    }, (err) => {
                                        reject(err)
                                    })
                                } else {
                                    reject(result)
                                }
                            }
                        }
                    )
                }

            })

        }

        Promise.prototype.catch = function (onRejected) {
            return this.then(undefined, onRejected)
        }

        const p2 = new Promise((resovle,reject) => {
                reject('catch error')
        })
        let res2 = p2.then(resolve=>{
            console.error(11)
        }).catch(err => {
            console.error(err)
        })
        console.error('result2', res2)






        function random(n, m) {
            return Math.round(Math.random() * (m - n) + n)
        }

        document.getElementById('clickButton').onclick = function () {
            const p = new Promise((resolve, reject) => {
                // reject('1')
                // resolve('2')
                // throw "error"
                setTimeout(() => {
                    let n = random(1, 100)
                    console.error(n)
                    if (n <= 30) {
                        // setTimeout(() => {
                        resolve(n)
                        // }, 1000);

                    } else {
                        reject(n)
                    }
                }, 200);
            })
            // let res = p.then((result) => {
            //     alert('congratulations' + result)
            // }, (reason) => {
            //     alert('unfortunately' + reason)
            // })
            let res = p.then((result) => {
                console.error('congratulations' + result)
            }, (reason) => {
                console.error('unfortunately' + reason)
            })
            console.error(p)
            console.error('result', res)
        }


    </script>
    </div>

</body>

</html>